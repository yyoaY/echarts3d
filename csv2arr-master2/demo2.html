<!DOCTYPE HTML>
<html>
<meta charset="utf-8"/>

<h3>请按F12打开浏览器控制台</h3>
<h3>Press F12 to open the console</h3>

<a href="./test.csv" >点击下载示例csv</a><br /><br /><br />

<input type="file" name="csvfile" />
<input type="button" onclick="csv2()" value="导出所需行"/>

<br /><br /><br />
<div id="resTbl"></div>

<script src="./lib/jquery.js"></script>
<script src="./lib/papaparse.js"></script>
<script src="./lib/jschardet.js"></script>
<!--[if lte IE 9]>
	<script src="./lib/base64.js"></script>
<![endif]-->

<script src="csv2arr2.js"></script>
<script>
var bnr=["CN","MG","PA","MA","IN","ET","NZ","BA","ME","TM","LT","LV","PS","AL","AF","EE","PK","SI","HR","LB","OM","BH","YE","EG","JO","SY","ID","PH","MM","BN","TL","BT","AE","TH","VN","SG","IL","AZ","AM","CZ","BD","BY","KH","GE","HU","IQ","IR","KG","LO","KZ","QA","KW","MD","MV","MY","MK","MN","NP","PL","BG","RO","RS","SA","SK","TJ","RU","ZA","LK","KR","TR","UA","UZ","BB","VU","TO","CK","EC","PT","FJ","FM","MT","SV","DO","CL","WS","SR","GD","VE","TG","GM","UG","CV","BI","TZ","ZW","CG","TD","NG","KE","AO","NA","GA","MZ","ZM","GH","SC","SS","CM","SL","KT","DZ","CR","DJ","MR","GN","SO","GR","UY","NU","DM","GY","RW","SN","TN","LY","PG","BO","AG","TT","AT","SD","IT","CU"];
function csv2(){
    $("input[name=csvfile]").csv2arr(function(arr){
        len=arr.length;
         var a=[],b=[],c=[];
        for(var i=0;i<len;i++) {
            //获取顶级域名，存入a[i]
            var doti = arr[i][3].lastIndexOf('.')
            a[i] = arr[i][3].slice(doti+1);

            //删除顶级域名为3位的行
            // 以20190307064500.translation.gkg.csv文件为例，删除前3236行，删除后2017行
            // if (a[i].length != 2) {
            //     arr.splice(i, 1);
            //     i--;
            //     len--;
            // }
            // else{
            //     //直接保存顶级域名,并转换为大写
            //     arr[i][3]=a[i].toUpperCase();
            // }

            //顶级域名转换为大写
            a[i]=a[i].toUpperCase();

            //若不存在于一带一路国家表中，则删除该行
            // 明天调整为先删行，再删列
            //以20190307064500.translation.gkg.csv文件为例，删除前3236行，删除后1245行

            if(bnr.indexOf(a[i])==-1){
                arr.splice(i, 1);
                i--;
                len--;
            }
            else{
                //直接保存顶级域名
                arr[i][3]=a[i];
            }
        }
        for(var i=0;i<len;i++){
            //通过4次splice操作删除多余的字段，只保留原数组中每行的下标为3、9、15的三个字段
            arr[i].splice(0,3);
            arr[i].splice(1,5);
            arr[i].splice(2,5);
            arr[i].splice(3,11);

            c[i]=arr[i][2].split(',')[0];
            if(parseFloat(c[i])>0){
                arr[i][2]="pos";
            }else if(parseFloat(c[i])==0){
                arr[i][2]="neu";
            }else{
                arr[i][2]="neg";
            }

            b[i]=arr[i][1].split(';');
            var lenbi=b[i].length;
            for(j=0;j<lenbi;j++){
                b[i][j]=b[i][j].split('#')[2];

                //若不存在于一带一路国家表中，则删除该国
                //以20190307064500.translation.gkg.csv文件为例，删除前1245行，删除后504行
                if(bnr.indexOf(b[i][j])==-1){
                    b[i].splice(j, 1);
                    j--;
                    lenbi--;
                }
            }
            //如果被报道的国家中没有一带一路的国家，则删除该行
            if(lenbi==0){
                arr.splice(i, 1);
                i--;
                len--;
            }else{
                arr[i][1]=b[i];
            }
        }
        console.log( arr );
    });}
</script>
</html>